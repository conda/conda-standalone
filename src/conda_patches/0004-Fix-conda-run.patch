From c994290b4d2c1d596c52ba4cd693d3f94d7f9cf9 Mon Sep 17 00:00:00 2001
From: jaimergp <jaimergp@users.noreply.github.com>
Date: Wed, 27 Aug 2025 15:45:55 +0200
Subject: [PATCH 4/4] Fix conda run

Co-authored-by: Jaida Rice <jaidarice@gmail.com>
---
 conda/__init__.py     |  5 ++++-
 conda/activate.py     |  4 ++++
 conda/base/context.py | 11 ++++-------
 conda/cli/main_run.py |  7 +++++++
 conda/utils.py        |  3 +--
 5 files changed, 20 insertions(+), 10 deletions(-)

diff --git a/conda/__init__.py b/conda/__init__.py
index 8b3b3c9b4..1d30d613a 100644
--- a/conda/__init__.py
+++ b/conda/__init__.py
@@ -58,7 +58,10 @@ __url__ = "https://github.com/conda/conda"
 if os.getenv("CONDA_ROOT") is None:
     os.environ["CONDA_ROOT"] = sys.prefix
 
-CONDA_PACKAGE_ROOT = abspath(dirname(__file__))
+if getattr(sys, "_MEIPASS", None):
+    CONDA_PACKAGE_ROOT = os.path.join(sys.prefix, "conda")
+else:
+    CONDA_PACKAGE_ROOT = abspath(dirname(__file__))
 """The conda package directory."""
 
 CONDA_SOURCE_ROOT = dirname(CONDA_PACKAGE_ROOT)
diff --git a/conda/activate.py b/conda/activate.py
index 0fcb5c59e..3830ab60d 100644
--- a/conda/activate.py
+++ b/conda/activate.py
@@ -756,6 +756,8 @@ class _Activator(metaclass=abc.ABCMeta):
             return ""
 
     def _get_activate_scripts(self, prefix):
+        if prefix is None:
+            return ()
         _script_extension = self.script_extension
         se_len = -len(_script_extension)
         try:
@@ -770,6 +772,8 @@ class _Activator(metaclass=abc.ABCMeta):
         )
 
     def _get_deactivate_scripts(self, prefix):
+        if prefix is None:
+            return ()
         _script_extension = self.script_extension
         se_len = -len(_script_extension)
         try:
diff --git a/conda/base/context.py b/conda/base/context.py
index df6b0b97e..e101c89ef 100644
--- a/conda/base/context.py
+++ b/conda/base/context.py
@@ -867,6 +867,8 @@ class Context(Configuration):
         addendum="Please use `conda.base.context.context.conda_exe_vars_dict` instead",
     )
     def conda_exe(self) -> PathType:
+        if getattr(sys, "_MEIPASS", None):
+            return sys.executable
         exe = "conda.exe" if on_win else "conda"
         return join(self.conda_prefix, BIN_DIRECTORY, exe)
 
@@ -906,14 +908,9 @@ class Context(Configuration):
                 "_CONDA_ROOT": self.conda_prefix,
             }
         else:
-            exe = os.path.join(
-                self.conda_prefix,
-                BIN_DIRECTORY,
-                "conda.exe" if on_win else "conda",
-            )
             return {
-                "CONDA_EXE": exe,
-                "_CONDA_EXE": exe,
+                "CONDA_EXE": sys.executable,
+                "_CONDA_EXE": sys.executable,
                 "_CE_M": None,
                 "_CE_CONDA": None,
                 "CONDA_PYTHON_EXE": sys.executable,
diff --git a/conda/cli/main_run.py b/conda/cli/main_run.py
index 2450d1401..8194fe89e 100644
--- a/conda/cli/main_run.py
+++ b/conda/cli/main_run.py
@@ -94,12 +94,19 @@ def configure_parser(sub_parsers: _SubParsersAction, **kwargs) -> ArgumentParser
 def execute(args: Namespace, parser: ArgumentParser) -> int:
     from ..base.context import context
     from ..common.compat import encode_environment
+    from ..common.path import paths_equal
     from ..core.prefix_data import PrefixData
     from ..exceptions import ArgumentError
     from ..gateways.disk.delete import rm_rf
     from ..gateways.subprocess import subprocess_call
     from ..utils import wrap_subprocess_call
 
+    if paths_equal(context.target_prefix, sys.prefix):
+        raise ArgumentError(
+            "Cannot use 'conda run' on conda-standalone's base environment; "
+            "choose a target environment with '-n' or '-p'."
+        )
+
     prefix_data = PrefixData.from_context()
     prefix_data.assert_environment()
 
diff --git a/conda/utils.py b/conda/utils.py
index 38648f99a..8a120b24a 100644
--- a/conda/utils.py
+++ b/conda/utils.py
@@ -14,8 +14,8 @@ from pathlib import Path
 from shutil import which
 from typing import TYPE_CHECKING
 
-from . import CondaError
 from .activate import _build_activator_cls
+from . import CondaError
 from .auxlib.compat import Utf8NamedTemporaryFile, shlex_split_unicode
 from .common.compat import isiterable, on_win
 from .common.url import path_to_url
@@ -222,7 +222,6 @@ def wrap_subprocess_call(
         multiline = True
     if on_win:
         comspec = get_comspec()  # fail early with KeyError if undefined
-
         with Utf8NamedTemporaryFile(mode="w", suffix=".bat", delete=False) as fh:
             silencer = "" if debug_wrapper_scripts else "@"
             fh.write(f"{silencer}ECHO OFF\n")
-- 
2.51.1.windows.1

